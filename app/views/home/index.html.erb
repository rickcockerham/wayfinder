<p><%= link_to "New Item", new_item_path %>
<%= link_to "Inventory", inventory_items_path %>
<%= link_to "Planner", planner_path %>
<%= image_tag "wayfinder_logo.png", alt: "Wayfinder", height: "80", class: "pull-right", id: "wayfinder-logo"%>
  <br>
  <button id="toggle-filters"
          type="button"
          aria-controls="filters-panel"
          aria-expanded="false">
    Filters ▾
  </button>

</p>
  <div id="filters-panel" hidden>
    <%= link_to "Reset filters", root_path(reset_filters: 1), class: "muted pull-right" %>
    <!-- Moods: checkboxes -->
    <%= form_with url: root_path, method: :get, local: true do %>
    <div>
      <strong>Mood:</strong><br>
      <% @moods.each do |m| %>
      <label style="margin-right:1rem;">
        <%= check_box_tag "mood_ids[]", m.id, @filters[:mood_ids].include?(m.id) %> <%= m.name %>
      </label>
      <% end %>
    </div>

    <!-- Category: select -->
    <div>
      <strong>Category:</strong><br>
      <%= select_tag :category_id,
          options_from_collection_for_select(Category.order(:name), :id, :name, @filters[:category_id]),
          include_blank: "All categories" %>
    </div>

    <!-- Time: slider -->
    <div>
      <strong>Time commitment:</strong>
      <label style="display:block;margin-top:.5rem">
        Time commitment:
        <%= select_tag :time_i,
            options_for_select(
            HomeController::TIME_INDEX_LABELS.each_with_index.map { |label, i| [label, i] },
            @filters[:time_i].to_i
            )
            %>
      </label>
    </div>

    <!-- Sort + per -->
    <div>
      <strong>Sort:</strong>
      <%= select_tag :sort, options_for_select([["By importance","importance"], ["By time","time"]], @filters[:sort]) %>

      <strong style="margin-left:1rem;">Show:</strong>
      <%= select_tag :per,
      options_for_select(FilterPersistence::PER_OPTIONS.map { |n| [n, n] }, @filters[:per].to_i) %>
    </div>

    <div><button type="submit">Update list</button></div>
    <% end %>
  </div>

<!-- Top items list -->
<a href="/items"><h2>Items</h2></a>
<div class="table-wrap"><!-- keeps desktop from overflowing if lots of columns -->
  <table class="items-table">
    <thead>
      <tr>
        <th>Title</th><th class="hide-sm">Category</th><th class="hide-sm">Mood</th><th class="hide-sm">Time</th>
        <th class="hide-sm">Impacts P/E/F</th><th class="hide-sm">Deadline</th><th class="hide-sm">Missing</th>
      </tr>
    </thead>
    <tbody>
      <% inv = InventoryItem.all.index_by { |i| i.name.downcase } %>
      <% @top_items.each do |it| %>
      <% missing = @missing_by_item[it.id] || [] %>
      <tr id="<%= dom_id(it) %>">
        <td data-label="Title"><%= link_to it.title, it %></td>
        <td data-label="Category" class="hide-sm"><%= it.category&.name %></td>
        <td data-label="Mood" class="hide-sm"><%= it.mood&.name %></td>
        <td data-label="Time" class="hide-sm"><%= it.time_estimate_minutes %>m</td>
        <td data-label="Impacts" class="hide-sm"><%= [it.personal_impact, it.emotional_impact, it.family_impact].join("/") %></td>
        <td data-label="Deadline" class="hide-sm"><%= it.deadline %></td>
        <td data-label="Missing">
          <% if missing.empty? %>
          ✅ ready
          <% else %>
          <%= missing.map { |m| "#{m[:name]}(#{m[:short]} #{m[:unit]})" }.join(", ") %>
          <% end %>
        </td>
      </tr>
      <% end %>
    </tbody>
  </table>
</div>

<!-- Shopping list by vendor -->
<a href="/shopping"><h2>Shopping list</h2></a>

<% if @shops.any? %>
  <%= form_with url: root_path, method: :get, local: true do %>
    <!-- preserve current filters while switching vendor -->
    <% (@selected_mood_ids || []).each do |mid| %>
      <input type="hidden" name="mood_ids[]" value="<%= mid %>">
    <% end %>
    <input type="hidden" name="category_id" value="<%= @selected_category_id %>">
    <input type="hidden" name="minutes" value="<%= @minutes %>">
    <input type="hidden" name="sort" value="<%= @sort %>">
    <input type="hidden" name="per" value="<%= @per %>">

    <label>Vendor:
      <select name="shop_id">
        <% @shops.each do |s| %>
          <option value="<%= s.id %>" <%= "selected" if s.id == @selected_shop_id %>><%= s.name %></option>
        <% end %>
      </select>
    </label>
    <button type="submit">Update</button>
  <% end %>

  <% if @shopping_list.present? %>
    <table border="1" cellpadding="6" style="margin-top:1rem;">
      <tr><th>Material</th><th>Short</th><th>Unit</th></tr>
      <% @shopping_list.each do |row| %>
        <tr>
          <td><%= row[:name] %></td>
          <td><%= row[:short] %></td>
          <td><%= row[:unit] %></td>
        </tr>
      <% end %>
    </table>
  <% else %>
    <p style="margin-top:1rem;">Nothing needed from this vendor for the current top items.</p>
  <% end %>
<% else %>
  <p>Add some Shops to see a shopping list.</p>
<% end %>

<%= link_to "Moods", moods_path %>
<%= link_to "Locations", locations_path %>
<%= link_to "Shops", shops_path %>
<%= link_to "Categories", categories_path %>
<%= link_to "Item Blocks", item_blocks_path %>
